<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/lib/Message.js | imkit-js-api-v3</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api">api</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/index.js~IMKitApi.html">IMKitApi</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-admin">api/admin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/admin/index.js~Admin.html">Admin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-auth">api/auth</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/auth/index.js~Auth.html">Auth</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-file">api/file</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/file/index.js~File.html">File</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-me">api/me</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/me/index.js~Me.html">Me</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-message">api/message</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/message/index.js~Message.html">Message</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-room">api/room</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/room/index.js~Room.html">Room</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-search">api/search</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/search/index.js~Search.html">Search</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-url">api/url</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/api/url/index.js~Url.html">Url</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#socket">socket</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/socket/index.js~IMKitSocket.html">IMKitSocket</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#typedef">typedef</a><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ApiConfig">ApiConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ClientData">ClientData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MessageData">MessageData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MessageInfo">MessageInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PushPayload">PushPayload</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RoomData">RoomData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RoomPref">RoomPref</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SocketConfig">SocketConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-TokenData">TokenData</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/lib/Message.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import forge from &apos;node-forge&apos;;
import CryptoJS from &apos;crypto-js&apos;;

/**
 * @import * from &apos;@/src/typedef&apos;;
 */

/**
 * @private
 */
class Message {
  /**
   * @private
   * @returns {Promise&lt;{publicKey: String, privateKey: String}|Error&gt;}
   */
  generateRsaKey() {
    return new Promise((resolve, reject) =&gt; {
      forge.pki.rsa.generateKeyPair(
        { bits: 2048, workers: 2 },
        (err, keypair) =&gt; {
          if (err) {
            reject(err);
          } else {
            let publicKey = forge.pki.publicKeyToPem(keypair.publicKey);
            let privateKey = forge.pki.privateKeyToPem(keypair.privateKey);
            resolve({
              publicKey: publicKey
                .replace(/-+END.*KEY-+/g, &apos;&apos;)
                .replace(/-+BEGIN.*KEY-+/g, &apos;&apos;)
                .replace(/\r\n|\n/g, &apos;&apos;),
              privateKey: privateKey
                .replace(/-+END.*KEY-+/g, &apos;&apos;)
                .replace(/-+BEGIN.*KEY-+/g, &apos;&apos;)
                .replace(/\r\n|\n/g, &apos;&apos;)
            });
          }
        }
      );
    });
  }

  /**
   * @private
   * @param {MessageData} message
   * @param {String} privateKey
   * @param {String} clientId
   * @returns {MessageData}
   */
  decrypt(message, privateKey, clientId) {
    if (message.messageType === &apos;encrypted&apos;) {
      try {
        let messageArray = message.message.split(&apos;|&apos;);
        let encrypted = messageArray
          .find(_message =&gt; {
            return atob(_message.split(&apos;:&apos;)[0]) === clientId;
          })
          .split(&apos;:&apos;);

        // RSA
        let key = this.rsaDecrypt(privateKey, encrypted[2]);
        let iv = this.rsaDecrypt(privateKey, encrypted[1]);

        // AES
        let messageStr = this.aesDecrypt(
          key,
          iv,
          messageArray[messageArray.length - 1]
        );

        message = Object.assign(message, JSON.parse(messageStr));
        if (message.reply) {
          message.reply = this.decrypt(message.reply, privateKey, clientId);
        }
        return message;
      } catch (e) {}
    }
    return message;
  }

  /**
   * @private
   * @param {RoomData} room
   * @param {MessageInfo} message
   * @returns {MessageInfo}
   */
  encrypt(room, message) {
    if (room.encrypted) {
      let reply = message.reply;
      delete message.reply;
      let messageStr = JSON.stringify(message);

      // AES
      let key = this.aesGenerateKey();
      let iv = this.aesGenerateKey();
      // AES &#x52A0;&#x5BC6;&#x5B57;&#x4E32;
      let aesEncryptedMessage = this.aesEncrypt(key, iv, messageStr);

      let messageArray = room.members
        .filter(member =&gt; {
          return member.publicKey;
        })
        .map(member =&gt; {
          // RSA
          let encryptedKey = this.rsaEncrypt(member.publicKey, key);
          let encryptedIv = this.rsaEncrypt(member.publicKey, iv);
          return `${btoa(member._id)}:${encryptedIv}:${encryptedKey}`;
        });

      messageArray.push(aesEncryptedMessage);
      return {
        messageType: &apos;encrypted&apos;,
        message: messageArray.join(&apos;|&apos;),
        reply: reply
      };
    }
    return message;
  }

  rsaEncrypt(publicKey, message) {
    let _publicKey = forge.pki.publicKeyFromPem(
      `-----BEGIN RSA PUBLIC KEY-----${publicKey}-----END RSA PUBLIC KEY-----`
    );

    return btoa(_publicKey.encrypt(atob(message), &apos;RSAES-PKCS1-V1_5&apos;));
  }

  rsaDecrypt(privateKey, encrypted) {
    let _privateKey = forge.pki.privateKeyFromPem(
      `-----BEGIN RSA PRIVATE KEY-----${privateKey}-----END RSA PRIVATE KEY-----`
    );

    return btoa(_privateKey.decrypt(atob(encrypted), &apos;RSAES-PKCS1-V1_5&apos;));
  }

  aesGenerateKey() {
    return btoa(CryptoJS.lib.WordArray.random(8));
  }

  aesEncrypt(key, iv, message) {
    let _key = CryptoJS.enc.Base64.parse(key);
    let _iv = CryptoJS.enc.Base64.parse(iv);

    return CryptoJS.AES.encrypt(message, _key, {
      iv: _iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    }).toString();
  }

  aesDecrypt(key, iv, encrypted) {
    let _key = CryptoJS.enc.Base64.parse(key);
    let _iv = CryptoJS.enc.Base64.parse(iv);

    return CryptoJS.AES.decrypt(encrypted.toString(), _key, {
      iv: _iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    }).toString(CryptoJS.enc.Utf8);
  }
}

export default Message;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
